<!DOCTYPE html>
<html>
	<head>
		<title>Restore workspace</title>
		<link rel="stylesheet" type="text/css" href="/css/main.css">
		<link rel="stylesheet" type="text/css" href="/css/syntax.css">
	</head>
	<body>
		<nav>
			<ul>
				<li><a href="/">Home</a></li>
				<li><a href="/blog">Blog</a></li>
			</ul>
		</nav>
		<div class="container">
			<h1>Restore workspace</h1>
<p class="meta">02 Mar 2017</p>

<div class="post">
     <p>Recently, I tried to setup my working environment. The product I worked on mostly using C++, and the application is running on one OS similar as BSD enabled multi-processes programming style. I owned one dedicate Linux machine to code, run function test, etc. but I don’t have the root permission. That machine provide nx server, it works quit well, but the nx server is too old that sometimes met annoying issue, only terminate session can solve the problem. Terminate session causes the working environment disappear. Another problem is the machine may reboot by administrator to do maintain work. Here is the current solution, it’s quit ok now.</p>

<ul>
  <li><a href="https://tmux.github.io/">tmux</a></li>
</ul>

<p>Tmux is used to keep the application without window, and also easy to manage different work area. And use <a href="https://github.com/tmux-plugins/tmux-resurrect">tmux-resurrect</a> to store the information incase OS is restarted.</p>

<ul>
  <li>ssh + shell script</li>
</ul>

<p>To get rid of nx server, use ssh directly. Tmux could not keep the X window’s session, here use shell script to restart the X11 application.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>ssh -YXC -c blowfish-cbc,arcfour user@host -t <span class="se">\"</span>tmux attach -t work <span class="se">\\\\</span>; split-window ~/bin/restore.sh<span class="se">\"</span><span class="s2">"
</span></code></pre>
</div>

<p>Below is the <code class="highlighter-rouge">restore.sh</code></p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

<span class="nv">PROMPT_START</span><span class="o">=</span><span class="s2">"</span><span class="se">\[</span><span class="k">$(</span>hostname<span class="k">)</span><span class="se">\]</span><span class="s2">"</span>
<span class="nv">ORIG_WINDOW_INDEX</span><span class="o">=</span><span class="sb">`</span>tmux display-message -p <span class="s1">'#I'</span><span class="sb">`</span>
<span class="nv">ORIG_PANE_INDEX</span><span class="o">=</span><span class="sb">`</span>tmux display-message -p <span class="s1">'#P'</span><span class="sb">`</span>

<span class="k">for </span>window <span class="k">in</span> <span class="sb">`</span>tmux list-windows -F <span class="s1">'#I'</span><span class="sb">`</span>; <span class="k">do
    </span>tmux <span class="k">select</span>-window -t <span class="nv">$window</span>

    <span class="k">for </span>pane <span class="k">in</span> <span class="k">$(</span>tmux list-panes -F <span class="s1">'#P'</span><span class="k">)</span>; <span class="k">do</span>
        <span class="c">#tmux send-keys -t ${pane} ""</span>
        <span class="nv">outputLines</span><span class="o">=</span><span class="k">$(</span>tmux capture-pane -p -t <span class="k">${</span><span class="nv">pane</span><span class="k">}</span> | tac<span class="k">)</span>
        <span class="nv">prompt_skipped</span><span class="o">=</span><span class="nb">false
        </span><span class="k">while </span><span class="nb">read</span> -r line; <span class="k">do
            if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$prompt_skipped</span><span class="s2">"</span> <span class="o">=</span> <span class="nb">true</span> <span class="o">]</span>; <span class="k">then
                </span><span class="nv">lastStopApp</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span> | perl -lne <span class="s1">'/\[\d+\]\s+(Abort|Done|Exit\s+\d+)\s+(.*)$/ &amp;&amp; print $2'</span><span class="k">)</span>
                <span class="k">if</span> <span class="o">[</span> ! -z <span class="s2">"</span><span class="nv">$lastStopApp</span><span class="s2">"</span> <span class="o">]</span>; <span class="k">then</span>
                    <span class="c">#echo "$lastStopApp Runs on pane $pane window $window" &gt;&gt; ~/start.log</span>
                    <span class="c">#TODO do more checks on APP</span>
                    tmux send-keys -t <span class="k">${</span><span class="nv">pane</span><span class="k">}</span> <span class="s2">"</span><span class="k">${</span><span class="nv">lastStopApp</span><span class="k">}</span><span class="s2">&amp;"</span> Enter
                <span class="k">fi
                </span><span class="nb">break
            </span><span class="k">fi

            if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span> <span class="o">=</span>~ ^<span class="nv">$PROMPT_START</span>.<span class="k">*</span> <span class="o">]]</span>; <span class="k">then
                </span><span class="nv">prompt_skipped</span><span class="o">=</span><span class="nb">true
            </span><span class="k">fi

        done</span> <span class="o">&lt;&lt;&lt;</span> <span class="s2">"</span><span class="nv">$outputLines</span><span class="s2">"</span>
    <span class="k">done
done

</span>tmux <span class="k">select</span>-window -t <span class="nv">$ORIG_WINDOW_INDEX</span>
tmux <span class="k">select</span>-pane -t <span class="nv">$ORIG_PANE_INDEX</span>
</code></pre>
</div>

<p>This script tries to restart the application which executed background and interrupt by the X11 display. Have limitation, this script only handle the last one in pane.</p>

<ul>
  <li>emacs + rtags</li>
</ul>

<p>Emacs’s desktop can keep the session quit good, rtags manages the C++ AST database.</p>

</div>

		</div>
		<footer>
			<ul>
				<li><a href="mailto:lbl52001@gmail.com">email</a></li>
				<li><a href="https://github.com/baolonglin">github page</a></li>
			</ul>
		</footer>
	</body>
</html>
